# 1.cmake 的 配置命令 和 构建命令

CMake 是一个跨平台的自动化建构系统，它通过 CMakeLists.txt 文件来管理项目的构建过程。使用 CMake 构建项目通常分为两个主要步骤：配置（Configure）和构建（Build），下面分别介绍这两个步骤对应的命令。

## 1.1.配置命令
配置步骤主要是根据项目的 CMakeLists.txt 文件生成对应平台的构建文件（如 Makefile、Visual Studio 项目文件等）。常用的配置命令如下：

### 1.1.1 基本配置命令
```bash
cmake -S <source_dir> -B <build_dir>
```
* 参数说明：
```
-S <source_dir>：指定项目源代码所在的目录，该目录下通常包含 CMakeLists.txt 文件。
-B <build_dir>：指定构建文件生成的目录，CMake 会在该目录下生成构建所需的文件。
```

### 1.1.2示例
假设你的项目源代码存放在 ~/my_project 目录下，你希望将构建文件生成到 ~/my_project/build 目录中，可以使用以下命令：
```bash
cmake -S ~/my_project -B ~/my_project/build
```

### 1.1.3其他常用选项
* 指定生成器：使用 -G 选项可以指定要生成的构建文件类型，例如生成 Makefile 或 Visual Studio 项目文件。
```bash
cmake -S <source_dir> -B <build_dir> -G "Unix Makefiles"
```

* 设置 CMake 变量：使用 -D 选项可以设置 CMake 变量，例如设置编译类型为 Release。
```bash
cmake -S <source_dir> -B <build_dir> -DCMAKE_BUILD_TYPE=Release
```

## 1.2.构建命令
构建步骤是根据配置步骤生成的构建文件来编译项目。构建命令取决于配置步骤生成的构建文件类型，以下是常见的构建命令：

### 1.2.1使用 Makefile 构建
如果配置步骤生成的是 Makefile，可以使用 make 命令来构建项目。
```bash
cmake -S <source_dir> -B <build_dir> -G "Unix Makefiles"
cd <build_dir>
make
```

* 并行构建：可以使用 -j 选项指定并行构建的线程数，以加快构建速度。
```bash
make -j$(nproc)  # 在 Linux 系统上使用系统的 CPU 核心数进行并行构建
```

### 1.2.2使用 Ninja 构建
如果配置步骤生成的是 Ninja 构建文件，可以使用 ninja 命令来构建项目。

```bash
cmake -S <source_dir> -B <build_dir> -G "Ninja"
cd <build_dir>
ninja
```

### 1.2.3使用 Visual Studio 构建
如果配置步骤生成的是 Visual Studio 项目文件，可以使用 msbuild 命令来构建项目。
```bash
cmake -S <source_dir> -B <build_dir> -G "Visual Studio 16 2019"
cd <build_dir>
msbuild YourProject.sln /p:Configuration=Release
```

## 1.3.总结
综上所述，CMake 的配置和构建过程通常是先使用 cmake -S -B 命令进行配置，然后根据生成的构建文件类型使用相应的构建命令进行编译。

# 2.cmake -P 模式

cmake -P 模式用于直接执行 CMake 脚本文件，而不需要生成构建系统文件（如 Makefile 或 Visual Studio 项目文件）。这种模式在需要执行一些简单的 CMake 脚本任务时非常有用，比如文件操作、变量计算、检查环境等。

When run in -P script mode, CMake sets the variables
``CMAKE_BINARY_DIR``, ``CMAKE_SOURCE_DIR``,
``CMAKE_CURRENT_BINARY_DIR`` and
``CMAKE_CURRENT_SOURCE_DIR`` to the current working directory.

## 2.1基本语法
```bash
cmake -P <script_file>
```

其中 <script_file> 是要执行的 CMake 脚本文件的路径，该文件通常以 .cmake 为扩展名。

## 2.2使用示例
### (1). 创建一个简单的 CMake 脚本
首先，创建一个名为 example.cmake 的文件，内容如下：
```cmake
# 设置一个变量
set(MESSAGE "Hello, CMake -P mode!")

# 输出变量的值
message(STATUS "${MESSAGE}")

# 获取当前日期
string(TIMESTAMP CURRENT_DATE "%Y-%m-%d")
message(STATUS "Current date: ${CURRENT_DATE}")
```

上述脚本完成了两个任务：一是设置一个字符串变量并输出其值，二是获取当前日期并输出。
### (2). 执行 CMake 脚本
在终端中使用 cmake -P 命令执行该脚本：
```bash
cmake -P example.cmake
```

执行后，终端会输出类似如下内容：
plaintext
-- Hello, CMake -P mode!
-- Current date: 2025-02-07

## 2.3常见应用场景
### (1)文件操作
可以使用 cmake -P 模式执行一些文件操作脚本，例如复制文件、删除文件等。以下是一个复制文件的示例脚本 copy_files.cmake：
```cmake
# 源文件路径
set(SOURCE_FILE "source.txt")
# 目标文件路径
set(TARGET_FILE "destination.txt")

# 复制文件
file(COPY ${SOURCE_FILE} DESTINATION ${CMAKE_CURRENT_LIST_DIR})

message(STATUS "File copied successfully.")
```
在终端执行：
```bash
cmake -P copy_files.cmake
```

### (2)环境检查
通过 CMake 脚本可以检查系统环境变量、编译器版本等信息。以下是一个检查系统环境变量的示例脚本 check_env.cmake：
```cmake
# 检查环境变量
if(DEFINED ENV{PATH})
    message(STATUS "PATH environment variable is defined: $ENV{PATH}")
else()
    message(STATUS "PATH environment variable is not defined.")
endif()
```

在终端执行：
```bash
cmake -P check_env.cmake
```
## 2.4注意事项
* **脚本文件路径**：确保提供的 CMake 脚本文件路径是正确的，否则会出现找不到文件的错误。
* **变量作用域**：在 -P 模式下执行的脚本中，变量的作用域和普通 CMake 项目中的作用域规则相同，需要注意变量的定义和使用范围。
* **脚本错误处理**：如果脚本中出现错误，cmake -P 命令会输出错误信息，需要根据错误信息进行相应的调试和修改。



# 3.如何调试 cmake 的配置阶段代码 和 构建阶段代码
在 CMake 项目中，配置阶段和构建阶段是两个不同的过程，下面分别介绍如何调试这两个阶段的代码。

## 3.1 调试 CMake 配置阶段代码
CMake 的配置阶段主要是执行CMakeLists.txt文件中的指令，生成构建系统所需的文件（如 Makefile 或 Visual Studio 项目文件）。以下是一些调试配置阶段代码的方法：

###  (1) 使用message命令
在CMakeLists.txt文件中，可以使用message命令输出调试信息。message命令有不同的模式，如STATUS、WARNING、FATAL_ERROR等。
```cmake
# CMakeLists.txt
cmake_minimum_required(VERSION 3.10)
project(MyProject)

# 输出调试信息
message(STATUS "Current source directory: ${CMAKE_CURRENT_SOURCE_DIR}")
message(STATUS "Current binary directory: ${CMAKE_CURRENT_BINARY_DIR}")

# 其他CMake指令...
add_executable(MyExecutable main.cpp)
```
在运行cmake命令时，会显示这些调试信息：
```sh
mkdir build
cd build
cmake ..
```

### (2) 使用--trace选项
cmake命令提供了--trace选项，可以详细跟踪 CMake 脚本的执行过程。它会输出每一条执行的 CMake 指令及其参数。
```sh
cmake --trace ..
```
如果想要更详细的信息，包括函数调用的堆栈跟踪，可以使用--trace-expand选项：
```sh
cmake --trace-expand ..
```

### (3). 使用CMAKE_DEBUG_OUTPUT变量
在CMakeLists.txt文件中设置 CMAKE_DEBUG_OUTPUT 变量为ON，可以启用 CMake 的调试输出。

```cmake
# CMakeLists.txt
set(CMAKE_DEBUG_OUTPUT ON)
cmake_minimum_required(VERSION 3.10)
project(MyProject)

# 其他CMake指令...
add_executable(MyExecutable main.cpp)
```

然后正常运行cmake命令：
```sh
mkdir build
cd build
cmake ..
```

## 3.2调试 CMake 构建阶段代码
构建阶段是根据配置阶段生成的构建系统文件（如 Makefile）来编译和链接项目。以下是一些调试构建阶段代码的方法：
### (1) 使用构建工具的详细输出选项

* Makefile：如果使用 Makefile 作为构建系统，可以使用VERBOSE=1选项来显示详细的编译和链接命令。
```sh
make VERBOSE=1
```

* Ninja：如果使用 Ninja 作为构建系统，可以使用-v选项来显示详细的命令。
```sh
ninja -v
```
### (2) 逐步构建
如果项目比较大，可以尝试逐步构建项目，每次只编译和链接一部分代码。例如，在 Makefile 中，可以指定要构建的目标：

```sh
make target_name
```

3. 调试编译错误
如果在构建阶段遇到编译错误，可以根据错误信息逐步排查问题。常见的错误包括语法错误、头文件包含错误、库文件链接错误等。可以通过查看详细的编译命令和错误信息来定位问题。
例如，如果遇到头文件包含错误，可以检查头文件的路径是否正确，是否缺少必要的include_directories指令。
```cmake
# CMakeLists.txt
cmake_minimum_required(VERSION 3.10)
project(MyProject)

# 添加头文件搜索路径
include_directories(/path/to/include)

add_executable(MyExecutable main.cpp)
```
通过以上方法，可以有效地调试 CMake 的配置阶段和构建阶段代码。

# 4."cmake --build build/ubuntu -- -j4 install"中的--的作用
在 cmake --build build/ubuntu -- -j4 install 这个命令中，-- 的作用是分隔 cmake --build 命令本身的参数和传递给底层构建工具（如 make、ninja 等）的参数。
## 4.1命令解析
* cmake --build build/ubuntu：cmake --build 是 CMake 提供的用于触发构建过程的命令。build/ubuntu 是构建目录，指定了 CMake 应该在该目录下执行构建操作，此目录通常包含 CMake 生成的构建系统文件（如 Makefile 或 build.ninja）。
  
* --：这个分隔符将 cmake --build 命令的参数和后续要传递给底层构建工具的参数区分开来。因为不同的构建工具可能有自己独特的命令行选项，使用 -- 可以确保这些选项能正确地传递给底层构建工具，而不会被 cmake --build 误解。
  
* -j4 install：这是传递给底层构建工具的参数。
    > -j4：对于像 make 这样的构建工具，-j 选项用于指定并行构建的线程数。-j4 表示同时使用 4 个线程进行编译，这样可以加快构建速度。
    > install：这是构建目标，指示构建工具执行安装操作，将编译好的程序、库文件等安装到指定的位置。
    
## 4.2示例说明
假设你使用的是基于 Makefile 的构建系统，cmake --build build/ubuntu -- -j4 install 命令实际上会在 build/ubuntu 目录下执行类似 make -j4 install 的操作。如果没有 -- 分隔符，cmake --build 可能无法正确识别 -j4 install 是要传递给 make 的参数，从而导致命令执行出错。
综上所述，-- 在这个命令中起到了清晰划分参数归属的重要作用，保证了命令的正确执行。


# 5. 构建多个目标
如果你想构建多个目标（比如 target1 和 target2），有两种可行的方式：
方式一：多次使用 --target 选项

```bash
cmake --build build/ubuntu -- -j$(job) --target target1 --target target2
```
方式二：不使用 --target 选项，直接列出目标
```bash
cmake --build build/ubuntu -- -j$(job) target1 target2
```